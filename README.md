# AI Patch Doctor

**The CLI tool that diagnoses and fixes AI API issues in under 60 seconds**

```bash
# Python
pipx run ai-patch doctor

# Node
npx ai-patch doctor
```

## What is AI Patch Doctor?

AI Patch Doctor is a dual-language (Python + Node.js) CLI tool for diagnosing and fixing AI API issues. It follows the natural CLI mental model of tools like `brew doctor`, `kubectl doctor`, and `terraform plan`.

**Run the doctor. Fix your AI API.**

## Features

- âœ… **4 Core Checks**: streaming, retries, cost, traceability
- âœ… **Interactive Doctor**: 2-question flow with auto-detection
- âœ… **Safe by Default**: Dry-run mode, reversible changes
- âœ… **Dual Language**: Python and Node with identical UX
- âœ… **100% Open Source**: No proprietary code, MIT licensed

## Quick Start

### Python

```bash
# Run directly with pipx (no install needed)
pipx run ai-patch doctor

# Or install first
pip install ai-patch
ai-patch doctor
```

### Node

```bash
# Run directly with npx (no install needed)
npx ai-patch doctor

# Or install globally
npm install -g ai-patch
ai-patch doctor
```

### First Run Example

```bash
$ ai-patch doctor

ğŸ” AI Patch Doctor - Interactive Mode

What's failing?
  1. streaming / SSE stalls / partial output
  2. retries / 429 / rate-limit chaos
  3. cost spikes
  4. traceability (request IDs, duplicates)
  5. prod-only issues (all checks)
Select [1-5, default: 5]: 1

What do you use?
  1. openai-compatible (default)
  2. anthropic
  3. gemini
Select [1-3, default: 1]: 1

âœ“ Detected: https://api.openai.com
âœ“ Provider: openai-compatible

ğŸ”¬ Running streaming checks...

âœ… SUCCESS

ğŸ“Š Report saved: ai-patch-reports/20260115-143022/

â†’ Next: All checks passed. Monitor your API usage in production.

Generated by AI Patch â€” re-run: npx ai-patch
```

## The 4 Core Checks

### 1. Streaming Check
**Diagnoses**: SSE stalls, partial output, chunk gaps

Checks for:
- SSE framing issues
- Time to first byte (TTFB) > 5s
- Chunk gaps > 2s
- Proxy buffering (nginx, envoy)
- Client read timeouts
- gzip/compression issues

### 2. Retries Check
**Diagnoses**: 429s, rate limit chaos, retry storms

Checks for:
- Retry-After header respect
- Exponential backoff implementation
- Retry cap (max 3 recommended)
- Mid-stream retry (dangerous!)
- Concurrent request limits

### 3. Cost Check
**Diagnoses**: Token spikes, runaway costs

Checks for:
- Prompt size limits
- max_tokens sanity (< 4096 recommended)
- Token/cost estimation
- Loop detection (tool/function loops)
- Missing cost guardrails

### 4. Traceability Check
**Diagnoses**: Missing request IDs, duplicate requests

Checks for:
- Stable request ID generation
- Duplicate request detection
- Provider request ID capture
- Correlation ID propagation
- Request logging

## Commands

### `ai-patch doctor` (default)
Interactive diagnosis - asks 2 questions and runs checks

```bash
ai-patch doctor                    # Interactive mode
ai-patch doctor --target=streaming # Specific check
ai-patch doctor --target=all       # All checks
```

### `ai-patch apply`
Apply suggested fixes

```bash
ai-patch apply --safe              # Apply with confirmation
```

### `ai-patch test`
Test specific functionality

```bash
ai-patch test --target=streaming   # Test streaming check
```

### `ai-patch share`
Create redacted share bundle

```bash
ai-patch share --redact            # Create redacted bundle
```

## Provider Support

Works with:
- **OpenAI API** (and OpenAI-compatible APIs)
- **Azure OpenAI**
- **Anthropic** (Claude)
- **Gemini**
- **Together AI**
- **Anyscale**
- **Fireworks AI**
- **OpenRouter**
- **Custom gateways** (LiteLLM, Portkey, Helicone)

Auto-detected from environment variables:
- `OPENAI_API_KEY` / `OPENAI_BASE_URL`
- `ANTHROPIC_API_KEY`
- `GEMINI_API_KEY`

## Installation

### Python (PyPI)

**Requirements**: Python 3.8+

```bash
# Using pipx (recommended)
pipx install ai-patch

# Using pip
pip install ai-patch

# From source
git clone https://github.com/michaelbrinkworth/ai-patch-doctor
cd ai-patch-doctor/python
pip install -e .
```

### Node (npm)

**Requirements**: Node 16+

```bash
# Global install
npm install -g ai-patch

# Local install
npm install ai-patch

# Using npx (no install)
npx ai-patch

# From source
git clone https://github.com/michaelbrinkworth/ai-patch-doctor
cd ai-patch-doctor/node
npm install && npm run build
```

## Report Generation

Every run generates two files in `./ai-patch-reports/<timestamp>/`:

1. **report.json** - Machine-readable report
2. **report.md** - Human-readable markdown

Reports include:
- Overall status (âœ… success / âš ï¸ warning / âŒ error)
- Detailed findings per check
- Metrics and measurements
- Recommended next steps
- Duration of checks

## Testing

### Run all test suites

```bash
# 1. Jest tests (structure/architecture)
npm test

# 2. Python functional tests
cd python && python3 tests/test_cli.py
# OR
pytest python/tests/

# 3. Validation script (consistency)
python3 validate.py
```

### Test Suites Overview

#### 1. Jest Test Suite (Structure & Architecture)
- **File**: `ai-patch.test.js`
- **Framework**: Jest
- **Tests**: 45+ tests
- **Run**: `npm test`

**Covers**:
- Shared code structure (Python & Node)
- Code reuse verification (no duplication)
- CLI structure validation
- Documentation checks
- Package structure validation
- Open source cleanliness checks

**Key test groups**:
- Shared Code Structure (15+ tests)
- Python/Node CLI Structure (20+ tests)
- Documentation (3 tests)
- Code Quality (3 tests)
- Functional Tests (3 tests)

#### 2. Python Test Suite (Functional)
- **File**: `python/tests/test_cli.py`
- **Framework**: Custom (pytest-compatible)
- **Tests**: 4 tests
- **Run**: `python3 python/tests/test_cli.py` or `pytest python/tests/`

**Covers**:
- Config auto-detection
- Report generation (JSON & Markdown)
- Check module imports
- Config validation

**Test functions**:
- `test_config_auto_detect()`
- `test_report_generation()`
- `test_check_modules_import()`
- `test_config_validation()`

#### 3. Validation Script (Consistency)
- **File**: `validate.py`
- **Framework**: Custom Python script
- **Checks**: 4 validation checks
- **Run**: `python3 validate.py`

**Covers**:
- Report schema validation
- Python package structure
- Node package structure
- Command consistency (Python vs Node)

**Validation functions**:
- `validate_report_schema()`
- `validate_python_structure()`
- `validate_node_structure()`
- `check_command_consistency()`

### Quick Run All Tests

```bash
npm test && cd python && python3 tests/test_cli.py && cd .. && python3 validate.py
```

These three suites cover structure, functionality, and consistency across the codebase.

## Architecture

### Code Structure

```
ai-patch-doctor/
â”œâ”€â”€ python/                       # Python implementation
â”‚   â”œâ”€â”€ checks/                   # 4 core checks
â”‚   â”‚   â”œâ”€â”€ streaming.py
â”‚   â”‚   â”œâ”€â”€ retries.py
â”‚   â”‚   â”œâ”€â”€ cost.py
â”‚   â”‚   â””â”€â”€ trace.py
â”‚   â”œâ”€â”€ config.py                 # Configuration
â”‚   â”œâ”€â”€ report.py                 # Report generation
â”‚   â”œâ”€â”€ src/ai_patch/             # CLI wrapper
â”‚   â”‚   â””â”€â”€ cli.py
â”‚   â”œâ”€â”€ tests/                    # Python tests
â”‚   â””â”€â”€ pyproject.toml
â”œâ”€â”€ node/                         # Node implementation
â”‚   â”œâ”€â”€ checks/                   # 4 core checks
â”‚   â”‚   â”œâ”€â”€ streaming.ts
â”‚   â”‚   â”œâ”€â”€ retries.ts
â”‚   â”‚   â”œâ”€â”€ cost.ts
â”‚   â”‚   â””â”€â”€ trace.ts
â”‚   â”œâ”€â”€ config.ts                 # Configuration
â”‚   â”œâ”€â”€ report.ts                 # Report generation
â”‚   â”œâ”€â”€ src/                      # CLI wrapper
â”‚   â”‚   â””â”€â”€ cli.ts
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ shared/                       # Shared resources
â”‚   â””â”€â”€ report-schema.json
â”œâ”€â”€ ai-patch.test.js              # Jest test suite
â”œâ”€â”€ validate.py                   # Validation script
â””â”€â”€ README.md
```

### Design Principles

1. **Dual Language**: Python and Node implementations with identical UX
2. **Code Reuse**: Shared architecture patterns across both languages
3. **Safe by Default**: Dry-run first, explicit confirmation for changes
4. **Open Source**: 100% MIT licensed, no proprietary dependencies

## Troubleshooting

### "Module not found" (Python)

```bash
# Ensure dependencies are installed
cd python
pip install -e .
```

### "Cannot find module" (Node)

```bash
# Rebuild TypeScript
cd node
npm run build
```

### "No issues found" but I have problems

```bash
# Run with all checks
ai-patch doctor --target=all

# Check environment variables
ai-patch config show

# File an issue on GitHub
```

### Tests failing

```bash
# Python tests
cd python
pip install -e .[dev]
pytest -v

# Node build
cd node
npm install
npm run build

# Jest tests
npm install
npm test
```

## Contributing

We welcome contributions! Please:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Make your changes
4. Run all tests (`npm test && pytest python/tests/`)
5. Commit your changes (`git commit -m 'Add amazing feature'`)
6. Push to the branch (`git push origin feature/amazing-feature`)
7. Open a Pull Request

## License

MIT License - See [LICENSE](./LICENSE) file for details.

## Support

- **GitHub Issues**: [Report bugs or request features](https://github.com/michaelbrinkworth/ai-patch-doctor/issues)
- **GitHub Discussions**: [Ask questions or share ideas](https://github.com/michaelbrinkworth/ai-patch-doctor/discussions)

## About

AI Patch Doctor helps developers diagnose and fix common AI API issues quickly and safely. Whether you're dealing with streaming stalls, rate limit chaos, cost spikes, or traceability problems, the doctor can help.

**Run the doctor. Fix your AI API. ğŸ”**

---

Made with â¤ï¸ by [Michael Brinkworth](https://github.com/michaelbrinkworth)

